services:
  # MySQL Database for Kitchen Service
  kitchen-db:
    image: mysql:8.0
    container_name: kitchen-db
    environment:
      MYSQL_ROOT_PASSWORD: rootpassword
      MYSQL_DATABASE: kitchen_db
      MYSQL_USER: kitchen_user
      MYSQL_PASSWORD: kitchen_pass
    ports:
      - "3307:3306"
    volumes:
      - kitchen_db_data:/var/lib/mysql
    networks:
      - resto-network
    healthcheck:
      test: [ "CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-prootpassword" ]
      interval: 10s
      timeout: 10s
      retries: 10
      start_period: 40s

  # MySQL Database for Inventory Service
  inventory-db:
    image: mysql:8.0
    container_name: inventory-db
    environment:
      MYSQL_ROOT_PASSWORD: rootpassword
      MYSQL_DATABASE: inventory_db
      MYSQL_USER: inventory_user
      MYSQL_PASSWORD: inventory_pass
    ports:
      - "3311:3306"
    volumes:
      - inventory_db_data:/var/lib/mysql
    networks:
      - resto-network
    healthcheck:
      test: [ "CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-prootpassword" ]
      interval: 10s
      timeout: 10s
      retries: 10
      start_period: 40s

  # MySQL Database for User Service
  user-db:
    image: mysql:8.0
    container_name: user-db
    environment:
      MYSQL_ROOT_PASSWORD: rootpassword
      MYSQL_DATABASE: user_db
      MYSQL_USER: user_user
      MYSQL_PASSWORD: user_pass
    ports:
      - "3312:3306"
    volumes:
      - user_db_data:/var/lib/mysql
    networks:
      - resto-network
    healthcheck:
      test: [ "CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-prootpassword" ]
      interval: 10s
      timeout: 10s
      retries: 10
      start_period: 40s

  # MySQL Database for Order Service
  order-db:
    image: mysql:8.0
    container_name: order-db
    environment:
      MYSQL_ROOT_PASSWORD: rootpassword
      MYSQL_DATABASE: order_db
      MYSQL_USER: order_user
      MYSQL_PASSWORD: order_pass
    ports:
      - "3310:3306"
    volumes:
      - order_db_data:/var/lib/mysql
    networks:
      - resto-network
    healthcheck:
      test: [ "CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-prootpassword" ]
      interval: 10s
      timeout: 10s
      retries: 10
      start_period: 40s

  # Kitchen Service (Python)
  kitchen-service-python:
    build:
      context: ./kitchen-service-python
      dockerfile: Dockerfile
    container_name: kitchen-service-python
    ports:
      - "4001:4001"
    environment:
      PYTHONUNBUFFERED: 1
      PORT: 4001
      DB_HOST: kitchen-db
      DB_PORT: 3306
      DB_USER: kitchen_user
      DB_PASSWORD: kitchen_pass
      DB_NAME: kitchen_db
      ORDER_SERVICE_URL: http://order-service-python:4004/graphql
    depends_on:
      kitchen-db:
        condition: service_healthy
    networks:
      - resto-network
    restart: unless-stopped

  # Inventory Service (Python)
  inventory-service-python:
    build:
      context: ./inventory-service-python
      dockerfile: Dockerfile
    container_name: inventory-service-python
    ports:
      - "4002:4002"
    environment:
      PYTHONUNBUFFERED: 1
      PORT: 4002
      DB_HOST: inventory-db
      DB_PORT: 3306
      DB_USER: inventory_user
      DB_PASSWORD: inventory_pass
      DB_NAME: inventory_db
      ORDER_SERVICE_URL: http://order-service-python:4004/graphql
      # Toko Sembako Integration URLs (Railway Cloud)
      TOKO_SEMBAKO_PRODUCT_URL: https://tubes-iae-anugerah-resto-production-3278.up.railway.app/graphql/product
      TOKO_SEMBAKO_INVENTORY_URL: https://tubes-iae-anugerah-resto-production-3278.up.railway.app/graphql/inventory
      TOKO_SEMBAKO_ORDER_URL: https://tubes-iae-anugerah-resto-production-3278.up.railway.app/graphql/order
    depends_on:
      inventory-db:
        condition: service_healthy
    networks:
      - resto-network
    restart: unless-stopped

  # User Service (Python)
  user-service-python:
    build:
      context: ./user-service-python
      dockerfile: Dockerfile
    container_name: user-service-python
    ports:
      - "4003:4003"
    environment:
      PYTHONUNBUFFERED: 1
      PORT: 4003
      DB_HOST: user-db
      DB_PORT: 3306
      DB_USER: user_user
      DB_PASSWORD: user_pass
      DB_NAME: user_db
      ORDER_SERVICE_URL: http://order-service-python:4004/graphql
    depends_on:
      user-db:
        condition: service_healthy
    networks:
      - resto-network
    restart: unless-stopped

  # Order Service (Python)
  order-service-python:
    build:
      context: ./order-service-python
      dockerfile: Dockerfile
    container_name: order-service-python
    ports:
      - "4004:4004"
    environment:
      PYTHONUNBUFFERED: 1
      PORT: 4004
      DB_HOST: order-db
      DB_PORT: 3306
      DB_USER: order_user
      DB_PASSWORD: order_pass
      DB_NAME: order_db
      KITCHEN_SERVICE_URL: http://kitchen-service-python:4001/graphql
      INVENTORY_SERVICE_URL: http://inventory-service-python:4002/graphql
      USER_SERVICE_URL: http://user-service-python:4003/graphql
    depends_on:
      order-db:
        condition: service_healthy
    networks:
      - resto-network
    restart: unless-stopped

volumes:
  kitchen_db_data:
  inventory_db_data:
  user_db_data:
  order_db_data:


networks:
  resto-network:
    driver: bridge
